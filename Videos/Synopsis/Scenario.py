# -*- coding: utf-8 -*-
##############################################################################
## Scenario
## 影片場景
##############################################################################
import os
import sys
import getopt
import time
import datetime
import requests
import threading
##############################################################################
import mysql . connector
from   mysql . connector                   import Error
##############################################################################
import AITK
from   AITK  . Database   . Query          import Query
from   AITK  . Database   . Connection     import Connection
from   AITK  . Database   . Pair           import Pair
from   AITK  . Database   . Columns        import Columns
##############################################################################
from   AITK  . Documents  . ParameterQuery import ParameterQuery as ParameterQuery
from   AITK  . Essentials . Relation       import Relation       as Relation
##############################################################################
## HAIRSREL       = "`affiliations`.`relations_people_0009`"
## HPICREL        = "`affiliations`.`relations_pictures_0009`"
## HAIRSNAM       = "`appellations`.`names_commons_0014`"
## HAIRSNOTE      = "`notez`.`notes_commons_0027`"
## HAIRSPARAM     = "`cios`.`parameters`"
## HairsShortType = 20
## HairsLongType  = 1100000000000000020
## HairsTypeName  = "Hairs"
##############################################################################
class Scenario           ( Columns                                         ) :
  ############################################################################
  def __init__           ( self                                            ) :
    ##########################################################################
    super ( ) . __init__ (                                                   )
    self      . Clear    (                                                   )
    ##########################################################################
    return
  ############################################################################
  def __del__ ( self                                                       ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  def Clear              ( self                                            ) :
    ##########################################################################
    self . Columns     = [                                                   ]
    self . Id          =  -1
    self . Uuid        =   0
    self . Used        =   1
    self . States      =   0
    self . SType       =   0
    self . Name        = ""
    self . Duration    =   0
    self . Description = {                                                   }
    self . ltime       =   0
    ##########################################################################
    self . PeopleUuid =   0
    ##########################################################################
    return
  ############################################################################
  def assign ( self , item                                                 ) :
    ##########################################################################
    self . Columns     = item . Columns
    self . Id          = item . Id
    self . Uuid        = item . Uuid
    self . Used        = item . Used
    self . States      = item . States
    self . SType       = item . SType
    self . Name        = item . Name
    self . Duration    = item . Duration
    self . Description = item . Description
    self . ltime       = item . ltime
    ##########################################################################
    return
  ############################################################################
  def set            ( self , item , value                                 ) :
    ##########################################################################
    a = item . lower (                                                       )
    ##########################################################################
    if               ( "id"          == a                                  ) :
      self . Id        = value
    ##########################################################################
    elif             ( "uuid"        == a                                  ) :
      self . Uuid      = value
    ##########################################################################
    elif             ( "used"        == a                                  ) :
      self . Used     = value
    ##########################################################################
    elif             ( "states"      == a                                  ) :
      self . States      = value
    ##########################################################################
    elif             ( "type"        == a                                  ) :
      self . SType       = value
    ##########################################################################
    elif             ( "name"        == a                                  ) :
      self . Name        = self . assureString ( value                       )
    ##########################################################################
    elif             ( "duration"    == a                                  ) :
      self . Duration    = value
    ##########################################################################
    elif             ( "description" == a                                  ) :
      ########################################################################
      if             ( isinstance ( value , dict                         ) ) :
        ######################################################################
        self . Description   = value
        ######################################################################
      elif           ( isinstance ( value , str                          ) ) :
        ######################################################################
        try                                                                  :
          ####################################################################
          self . Description = json . loads ( value                          )
          ####################################################################
        except                                                               :
          pass
        ######################################################################
      elif           ( isinstance ( value , bytearray                    ) ) :
        ######################################################################
        try                                                                  :
          ####################################################################
          BODY = value . decode ( "utf-8"                                    )
          self . Description = json . loads ( BODY                           )
          ####################################################################
        except                                                               :
          pass
    ##########################################################################
    elif             ( "ltime"     == a                                    ) :
      self . ltime     = value
    ##########################################################################
    return
  ############################################################################
  def get            ( self , item                                         ) :
    ##########################################################################
    a = item . lower (                                                       )
    ##########################################################################
    if               ( "id"          == a                                  ) :
      return self . Id
    ##########################################################################
    if               ( "uuid"        == a                                  ) :
      return self . Uuid
    ##########################################################################
    if               ( "used"        == a                                  ) :
      return self . Used
    ##########################################################################
    if               ( "states"      == a                                  ) :
      return self . States
    ##########################################################################
    if               ( "type"        == a                                  ) :
      return self . SType
    ##########################################################################
    if               ( "name"        == a                                  ) :
      return self . Name
    ##########################################################################
    if               ( "duration"    == a                                  ) :
      return self . Duration
    ##########################################################################
    if               ( "description" == a                                  ) :
      return self . Description
    ##########################################################################
    if               ( "ltime"       == a                                  ) :
      return self . ltime
    ##########################################################################
    return ""
  ############################################################################
  def tableItems        ( self                                             ) :
    return [ "id"                                                            ,
             "uuid"                                                          ,
             "used"                                                          ,
             "states"                                                        ,
             "type"                                                          ,
             "name"                                                          ,
             "duration"                                                      ,
             "description"                                                   ,
             "ltime"                                                         ]
  ############################################################################
  def pair              ( self , item                                      ) :
    v = self . get      (        item                                        )
    return f"`{item}` = {v}"
  ############################################################################
  def valueItems        ( self                                             ) :
    return [ "used"                                                          ,
             "states"                                                        ,
             "type"                                                          ,
             "name"                                                          ,
             "duration"                                                      ,
             "description"                                                   ]
  ############################################################################
  def toJson ( self                                                        ) :
    return   { "Id"          : self . Id                                   , \
               "Uuid"        : self . Uuid                                 , \
               "Used"        : self . Used                                 , \
               "States"      : self . States                               , \
               "Type"        : self . SType                                , \
               "Name"        : self . Name                                 , \
               "Duration"    : self . Duration                             , \
               "Description" : self . Description                            }
  ############################################################################
  def toSTime   ( self , SDT                                               ) :
    ##########################################################################
    MDT   = int ( SDT / 60                                                   )
    RDT   = int ( SDT % 60                                                   )
    ##########################################################################
    if          ( MDT <= 0                                                 ) :
      return f"{RDT}"
    ##########################################################################
    TDK   = f"{RDT}"
    ##########################################################################
    while       ( len ( f"{TDK}" ) < 2                                     ) :
      TDK = f"0{TDK}"
    ##########################################################################
    ZDT   = int ( MDT / 60                                                   )
    HDT   = int ( MDT % 60                                                   )
    ##########################################################################
    if          ( ZDT <= 0                                                 ) :
      return f"{HDT}:{TDK}"
    ##########################################################################
    HDK   = f"{HDT}"
    ##########################################################################
    while       ( len ( f"{HDK}" ) < 2                                     ) :
      HDK = f"0{HDK}"
    ##########################################################################
    return f"{ZDT}:{HDK}:{TDK}"
  ############################################################################
  def toFTime   ( self , MSEC                                              ) :
    ##########################################################################
    SDT   = int ( MSEC / 1000000                                             )
    RDT   = int ( MSEC % 1000000                                             )
    ##########################################################################
    RDK   = f"{RDT}"
    ##########################################################################
    while       ( len ( f"{RDK}" ) < 6                                     ) :
      RDK = f"0{RDK}"
    ##########################################################################
    PDK   = self . toSTime ( SDT                                             )
    ##########################################################################
    return f"{PDK}.{RDK}"
  ############################################################################
  def toLTime   ( self , MSEC                                              ) :
    ##########################################################################
    SDT   = int ( MSEC / 1000000                                             )
    KDT   = int ( MSEC % 1000000                                             )
    RDT   = int ( KDT  /    1000                                             )
    ##########################################################################
    RDK   = f"{RDT}"
    ##########################################################################
    while       ( len ( f"{RDK}" ) < 3                                     ) :
      RDK = f"0{RDK}"
    ##########################################################################
    PDK   = self . toSTime ( SDT                                             )
    ##########################################################################
    return f"{PDK}.{RDK}"
    ##########################################################################
    return
  ############################################################################
  def FromFTime             ( self , MSG                                   ) :
    ##########################################################################
    MAT       = 0
    DOTs      = 0
    TMAKs     = 0
    MLEN      = len         ( MSG                                            )
    RS        =             [ "0" , "1" , "2" , "3" , "4" , "5"            , \
                              "6" , "7" , "8" , "9" , ":" , "."              ]
    ##########################################################################
    while                   ( MAT < MLEN                                   ) :
      ########################################################################
      V       = MSG         [ MAT : MAT + 1                                  ]
      ########################################################################
      if                    ( V not in RS                                  ) :
        return              ( False , 0 ,                                    )
      ########################################################################
      if                    ( "." == V                                     ) :
        DOTs  = int         ( DOTs + 1                                       )
      ########################################################################
      if                    ( ":" == V                                     ) :
        TMAKs = int         ( TMAKs + 1                                      )
      ########################################################################
      MAT     = int         ( MAT + 1                                        )
    ##########################################################################
    if                      ( DOTs  > 1                                    ) :
      return                ( False , 0 ,                                    )
    ##########################################################################
    if                      ( TMAKs > 2                                    ) :
      return                ( False , 0 ,                                    )
    ##########################################################################
    RV        = 0
    MV        = 0
    MS        = ""
    ##########################################################################
    if                      ( "." in MSG                                   ) :
      ########################################################################
      RZs     = MSG . split ( "."                                            )
      ########################################################################
      if                    ( 2 != len ( RZs )                             ) :
        return              ( False , 0 ,                                    )
      ########################################################################
      MS      = RZs         [ 0                                              ]
      RS      = RZs         [ 1                                              ]
      ########################################################################
      if                    ( ":" in RS                                    ) :
        return              ( False , 0 ,                                    )
      ########################################################################
      if                    ( len ( RS ) > 6                               ) :
        return              ( False , 0 ,                                    )
      ########################################################################
      while                 ( len ( RS ) < 6                               ) :
        RS    = f"{RS}0"
      ########################################################################
      RV      = int         ( RS                                             )
      ########################################################################
    else                                                                     :
      ########################################################################
      MS  = MSG
    ##########################################################################
    MZs   = MS . split      ( ":"                                            )
    COLs  = len             ( MZs                                            )
    ##########################################################################
    if                      ( 1 == COLs                                    ) :
      ########################################################################
      MV  = int             ( MZs [ 0                                      ] )
      ########################################################################
    elif                    ( 2 == COLs                                    ) :
      ########################################################################
      ZV  = int             ( MZs [ 0                                      ] )
      SV  = int             ( MZs [ 1                                      ] )
      MV  = int             ( int ( ZV * 60 ) + SV                           )
      ########################################################################
    else                                                                     :
      ########################################################################
      HV  = int             ( MZs [ 0                                      ] )
      ZV  = int             ( MZs [ 1                                      ] )
      SV  = int             ( MZs [ 2                                      ] )
      MV  = int             ( int ( HV * 3600 ) + int ( ZV * 60 ) + SV       )
    ##########################################################################
    TT    = int             ( int ( MV * 1000000 ) + RV                      )
    ##########################################################################
    return                  ( True  , TT ,                                   )
  ############################################################################
  def CountFirstTotal   ( self , DB , REL , TABLE , RELTAB , UsedOptions   ) :
    ##########################################################################
    UQ   = " , " . join ( str(x) for x in UsedOptions                        )
    UUID = REL . get    ( "second"                                           )
    T1   = REL . get    ( "t1"                                               )
    T2   = REL . get    ( "t2"                                               )
    RR   = REL . get    ( "relation"                                         )
    ##########################################################################
    MQ   = f"""select `uuid` from {TABLE} where ( `used` in ( {UQ} ) )"""
    QQ   = f"""select count(`first`) from {RELTAB}
               where ( `second` = {UUID} )
                 and ( `t1` = {T1} )
                 and ( `t2` = {T2} )
                 and ( `relation` = {RR} )
                 and ( `first` in ( {MQ} ) ) ;"""
    ##########################################################################
    return DB . GetOne  ( " " . join ( QQ . split ( ) ) , 0                  )
  ############################################################################
  def CountSecondTotal  ( self , DB , REL , TABLE , RELTAB , UsedOptions   ) :
    ##########################################################################
    UQ   = " , " . join ( str(x) for x in UsedOptions                        )
    UUID = REL . get    ( "first"                                            )
    T1   = REL . get    ( "t1"                                               )
    T2   = REL . get    ( "t2"                                               )
    RR   = REL . get    ( "relation"                                         )
    ##########################################################################
    MQ   = f"""select `uuid` from {TABLE} where ( `used` in ( {UQ} ) )"""
    QQ   = f"""select count(`second`) from {RELTAB}
               where ( `first` = {UUID} )
                 and ( `t1` = {T1} )
                 and ( `t2` = {T2} )
                 and ( `relation` = {RR} )
                 and ( `second` in ( {MQ} ) ) ;"""
    ##########################################################################
    return DB . GetOne  ( " " . join ( QQ . split ( ) ) , 0                  )
  ############################################################################
  def CountTotal       ( self , DB , TABLE , UsedOptions                   ) :
    ##########################################################################
    UQ = " , " . join  ( str(x) for x in UsedOptions                         )
    QQ = f"""select count(*) from {TABLE} where ( `used` in ( {UQ} ) ) ;"""
    ##########################################################################
    return DB . GetOne ( " " . join ( QQ . split ( ) ) , 0                   )
  ############################################################################
  def CountPeople            ( self , DB , TABLE , UUID                    ) :
    ##########################################################################
    REL        = Relation    (                                               )
    REL        . set         ( "first" , UUID                                )
    REL        . setT1       ( "Scenario"                                    )
    REL        . setT2       ( "People"                                      )
    REL        . setRelation ( "Contains"                                    )
    ##########################################################################
    return REL . CountSecond ( DB , TABLE                                    )
  ############################################################################
  def SqlDataToJson               ( self , RR                              ) :
    ##########################################################################
    if                            ( 8 != len ( RR )                        ) :
      return                      ( False , { } ,                            )
    ##########################################################################
    C   = self . assureItemString ( RR [ 5                                 ] )
    S   = self . assureItemString ( RR [ 7                                 ] )
    D   =                         {                                          }
    ##########################################################################
    try                                                                      :
      ########################################################################
      D = json . loads            ( S                                        )
      ########################################################################
    except                                                                   :
      pass
    ##########################################################################
    J   =                         { "Id"          : int ( RR [ 0       ] ) , \
                                    "Uuid"        : int ( RR [ 1       ] ) , \
                                    "Name"        : ""                     , \
                                    "Used"        : int ( RR [ 2       ] ) , \
                                    "States"      : int ( RR [ 3       ] ) , \
                                    "Type"        : int ( RR [ 4       ] ) , \
                                    "Scope"       : C                      , \
                                    "Duration"    : int ( RR [ 6       ] ) , \
                                    "Description" : D                        }
    ##########################################################################
    return                        ( True  , J ,                              )
  ############################################################################
  def SqlDataToJsonListings          ( self , RR                           ) :
    ##########################################################################
    if                               ( RR in [ False , None              ] ) :
      return                         [                                       ]
    ##########################################################################
    if                               ( len ( RR ) <= 0                     ) :
      return                         [                                       ]
    ##########################################################################
    LISTs     =                      [                                       ]
    ##########################################################################
    for R in RR                                                              :
      ########################################################################
      A , J   = self . SqlDataToJson ( R                                     )
      ########################################################################
      if                             ( A                                   ) :
        LISTs . append               ( J                                     )
    ##########################################################################
    return LISTs
  ############################################################################
  def FetchListsByFirst                 ( self                             , \
                                          DB                               , \
                                          SCNTAB                           , \
                                          RELTAB                           , \
                                          REL                              , \
                                          UsedOptions                      , \
                                          StartId                          , \
                                          Amount                           , \
                                          SortOrder                        ) :
    ##########################################################################
    COL   = "`id`,`uuid`,`used`,`states`,`type`,`name`,`duration`,`description`"
    UQ    = " , " . join                ( str(x) for x in UsedOptions        )
    UUID  = REL . get                   ( "first"                            )
    T1    = REL . get                   ( "t1"                               )
    T2    = REL . get                   ( "t2"                               )
    RR    = REL . get                   ( "relation"                         )
    ##########################################################################
    MQ    = f"""select `uuid` from {SCNTAB} where ( `used` in ( {UQ} ) )"""
    QQ    = f"""select `second` from {RELTAB}
               where ( `first` = {UUID} )
                 and ( `t1` = {T1} )
                 and ( `t2` = {T2} )
                 and ( `relation` = {RR} )
                 and ( `second` in ( {MQ} ) )
                 order by `position` {SortOrder}
                 limit {StartId} , {Amount} ;"""
    ##########################################################################
    UUIDs = DB . ObtainUuids            ( " " . join ( QQ . split (      ) ) )
    ##########################################################################
    RR    =                             [                                    ]
    ##########################################################################
    for U in UUIDs                                                           :
      ########################################################################
      QQ  = f"""select {COL} from {SCNTAB} where ( `uuid` = {U} ) ;"""
      DB  . Query                       ( " " . join ( QQ . split (      ) ) )
      R   = DB . FetchOne               (                                    )
      RR  . append                      ( R                                  )
    ##########################################################################
    return self . SqlDataToJsonListings ( RR                                 )
  ############################################################################
  def FetchListsBySecond                ( self                             , \
                                          DB                               , \
                                          SCNTAB                           , \
                                          RELTAB                           , \
                                          REL                              , \
                                          UsedOptions                      , \
                                          StartId                          , \
                                          Amount                           , \
                                          SortOrder                        ) :
    ##########################################################################
    COL   = "`id`,`uuid`,`used`,`states`,`type`,`name`,`duration`,`description`"
    UQ    = " , " . join                ( str(x) for x in UsedOptions        )
    UUID  = REL . get                   ( "second"                           )
    T1    = REL . get                   ( "t1"                               )
    T2    = REL . get                   ( "t2"                               )
    RR    = REL . get                   ( "relation"                         )
    ##########################################################################
    MQ    = f"""select `uuid` from {SCNTAB} where ( `used` in ( {UQ} ) )"""
    QQ    = f"""select `first` from {RELTAB}
               where ( `second` = {UUID} )
                 and ( `t1` = {T1} )
                 and ( `t2` = {T2} )
                 and ( `relation` = {RR} )
                 and ( `first` in ( {MQ} ) )
                 order by `reverse` {SortOrder}
                 limit {StartId} , {Amount} ;"""
    ##########################################################################
    UUIDs = DB . ObtainUuids            ( " " . join ( QQ . split (      ) ) )
    ##########################################################################
    RR    =                             [                                    ]
    ##########################################################################
    for U in UUIDs                                                           :
      ########################################################################
      QQ  = f"""select {COL} from {SCNTAB} where ( `uuid` = {U} ) ;"""
      DB  . Query                       ( " " . join ( QQ . split (      ) ) )
      R   = DB . FetchOne               (                                    )
      RR  . append                      ( R                                  )
    ##########################################################################
    return self . SqlDataToJsonListings ( RR                                 )
  ############################################################################
  def FetchLists                        ( self                             , \
                                          DB                               , \
                                          SCNTAB                           , \
                                          OPTs                             , \
                                          StartId                          , \
                                          Amount                           , \
                                          SortOrder                        ) :
    ##########################################################################
    UQ  = " , " . join                  ( str(x) for x in OPTs               )
    COL   = "`id`,`uuid`,`used`,`states`,`type`,`name`,`duration`,`description`"
    QQ  = f"""select {COL} from {SCNTAB}
               where ( `used` in ( {UQ} ) )
               order by `id` {SortOrder}
               limit {StartId} , {Amount} ;"""
    DB  . Query                         ( " " . join ( QQ . split (      ) ) )
    RR  = DB . FetchAll                 (                                    )
    ##########################################################################
    return self . SqlDataToJsonListings ( RR                                 )
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
##############################################################################
