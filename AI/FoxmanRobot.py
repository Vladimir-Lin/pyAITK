# -*- coding: utf-8 -*-
##############################################################################
## Foxman代理人
##############################################################################
import os
import sys
import subprocess
import getopt
import time
import datetime
import logging
import requests
import threading
import gettext
import shutil
import json
##############################################################################
from . ScheduleNotifier import ScheduleNotifier as ScheduleNotifier
##############################################################################
## Foxman智能回應程式
##############################################################################
class FoxmanRobot (                                                        ) :
  ############################################################################
  def __init__         ( self , jsonFile = ""                              ) :
    ##########################################################################
    self . DebugLogger   = None
    self . Talk          = None
    self . Reboot        = None
    self . StopIt        = None
    self . State         = 0
    self . CurrentDir    = ""
    self . Beau          = "Foxman"
    self . PullCommand   = ""
    self . PushCommand   = ""
    self . tblHost       = "http://insider.actions.com.tw:8364"
    self . sohoHost      = "http://soho.actions.com.tw:8364"
    self . tblSerial     = ""
    self . CalendarsFile = ""
    self . Scheduler     = None
    ##########################################################################
    self . Configure   (        jsonFile                                     )
    ##########################################################################
    self . tblPaperX    = self . JSON [ "Paper" ] [ "X"      ]
    self . tblPaperY    = self . JSON [ "Paper" ] [ "Y"      ]
    self . tblPaperGap  = self . JSON [ "Paper" ] [ "Gap"    ]
    self . tblPaperW    = self . JSON [ "Paper" ] [ "Width"  ]
    self . tblPaperH    = self . JSON [ "Paper" ] [ "Height" ]
    self . tblPaperL    = self . JSON [ "Paper" ] [ "Length" ]
    self . tblPaperText = self . JSON [ "Paper" ] [ "Text"   ]
    ##########################################################################
    return
  ############################################################################
  def __del__    ( self                                                    ) :
    return
  ############################################################################
  def Configure            ( self , jsonFile = ""                          ) :
    ##########################################################################
    self . JsonFile = f"{jsonFile}"
    ##########################################################################
    return self . LoadJSON (                                                 )
  ############################################################################
  def LoadJSON   ( self                                                    ) :
    ##########################################################################
    self  . JSON = { }
    J            = self  . JsonFile
    ##########################################################################
    if                          ( len ( J ) <= 0                           ) :
      return False
    ##########################################################################
    if                          ( not os . path . isfile ( J )             ) :
      return False
    ##########################################################################
    T     = ""
    try                                                                      :
      with open                 ( J , "rb" ) as F                            :
        T = F . read            (                                            )
    except                                                                   :
      return False
    ##########################################################################
    if                          ( len ( T ) <= 0                           ) :
      return False
    ##########################################################################
    BODY     = T . decode       ( "utf-8"                                    )
    if                          ( len ( BODY ) <= 0                        ) :
      return False
    ##########################################################################
    self  . JSON = json . loads ( BODY                                       )
    ##########################################################################
    return True
  ############################################################################
  def StoreJSON  ( self                                                    ) :
    ##########################################################################
    if           ( len ( self . JsonFile ) <= 0                            ) :
      return False
    ##########################################################################
    try                                                                      :
      with     open ( self . JsonFile , 'w' , encoding = 'utf-8' ) as f      :
        json . dump ( self  . JSON , f , ensure_ascii = False , indent = 2   )
    except                                                                   :
      return False
    ##########################################################################
    return True
  ############################################################################
  def debug                        ( self , message , way = "info"         ) :
    ##########################################################################
    Logger   = self . DebugLogger
    ##########################################################################
    if                             ( Logger == None                        ) :
      return
    ##########################################################################
    if                             ( way == "debug"                        ) :
      Logger . debug               ( message                                 )
    elif                           ( way == "info"                         ) :
      Logger . info                ( message                                 )
    ##########################################################################
    return
  ############################################################################
  def HttpParser                   ( self , Path , Headers , JSON          ) :
    return                         { "Process" : False                       }
  ############################################################################
  def ActualTalkTo                 ( self , beau , message                 ) :
    ##########################################################################
    if                             ( self . Talk == None                   ) :
      return False
    ##########################################################################
    time . sleep                   ( 1.0                                     )
    self . Talk                    ( beau , message                          )
    ##########################################################################
    return True
  ############################################################################
  def TalkTo                       ( self , beau , message                 ) :
    threading . Thread             ( target = self . ActualTalkTo          , \
                                     args = ( beau , message , ) ) . start ( )
    return True
  ############################################################################
  def Reply                        ( self , beau , message                 ) :
    ##########################################################################
    if                             ( self . State ==  0                    ) :
      self . IdleState             (        beau , message                   )
      return True
    ##########################################################################
    if                             ( self . State ==  1                    ) :
      self . BasicMode             (        beau , message                   )
      return True
    ##########################################################################
    if                             ( self . State == 11                    ) :
      self . tblMode               (        beau , message                   )
      return True
    ##########################################################################
    if                             ( self . State == 12                    ) :
      self . tblBettings           (        beau , message                   )
      return True
    ##########################################################################
    if                             ( self . State == 21                    ) :
      self . CalendarMode          (        beau , message                   )
      return True
    ##########################################################################
    if                             ( self . State == 22                    ) :
      self . CalendarTitle         (        beau , message                   )
      return True
    ##########################################################################
    if                             ( self . State == 23                    ) :
      self . CalendarDescription   (        beau , message                   )
      return True
    ##########################################################################
    return True
  ############################################################################
  def IdleState                    ( self , beau , message                 ) :
    ##########################################################################
    s    = message . lower         (                                         )
    s    = s       . rstrip        (                                         )
    beau = "Idle"
    STAS = "Startup"
    CALS = "Calendars"
    TBLS = "Taiwan-Big-Lottery"
    ##########################################################################
    if   ( s in self . JSON [ "Commands" ] [ STAS ] [ "Allows" ] )           :
      ########################################################################
      self . State = 1
      MSG          = self . JSON [ "Commands" ] [ STAS ] [ "Welcome" ]
      self . TalkTo                ( self . Beau , MSG                       )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ CALS ] [ "Allows" ] )             :
      ########################################################################
      self . StartCalendar         (                                         )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ TBLS ] [ "Allows" ] )             :
      self . State = 11
      MSG          = self . JSON [ "Commands" ] [ TBLS ] [ "Welcome" ]
      self . TalkTo                ( self . Beau , MSG                       )
      return True
    ##########################################################################
    return True
  ############################################################################
  def BasicMode                    ( self , beau , message                 ) :
    ##########################################################################
    s    = message . lower         (                                         )
    s    = s       . rstrip        (                                         )
    L    = s       . split         ( ' '                                     )
    CNT  = len                     ( L                                       )
    beau = "Basic"
    ##########################################################################
    ## 重新啟動
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Reboot" ] [ "Allows" ] )         :
      ########################################################################
      if                           ( self . Scheduler != None              ) :
        self . Scheduler . Stop    (                                         )
      ########################################################################
      self . Reboot                (                                         )
      ########################################################################
      return True
    ##########################################################################
    ## 中止程式
    ##########################################################################
    if ( CNT == 1 ) and ( s in self . JSON [ "Commands" ] [ "Stop" ] [ "Allows" ] ) :
      ########################################################################
      if                           ( self . Scheduler != None              ) :
        self . Scheduler . Stop    (                                         )
      ########################################################################
      self . StopIt                (                                         )
      ########################################################################
      return True
    ##########################################################################
    ## 結束互動模式
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Finish" ] [ "Allows" ]         ) :
      ########################################################################
      self . State = 0
      MSG          = self . JSON [ "Commands" ] [ "Finish" ] [ "Welcome" ]
      self . TalkTo                ( beau , MSG                              )
      ########################################################################
      return True
    ##########################################################################
    ## 設定
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Settings" ] [ "Allows" ]       ) :
      ########################################################################
      MSG = json . dumps           ( self . JSON , ensure_ascii = False      )
      self . TalkTo                ( "settings" , MSG                        )
      ########################################################################
      return True
    ##########################################################################
    if                             ( CNT <= 0                              ) :
      return True
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "Current" ] [ "Allows" ]  ) :
      ########################################################################
      if ( CNT > 1                                                         ) :
        ######################################################################
        ## 當前目錄
        ######################################################################
        if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Directory" ] [ "Allows" ] ) :
          ####################################################################
          self . OsGetCWD          (                                         )
          ####################################################################
          return True
    ##########################################################################
    ## 當前目錄
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "PWD" ] [ "Allows" ]      ) :
      ########################################################################
      self     . OsGetCWD          (                                         )
      ########################################################################
      return True
    ##########################################################################
    ## 改變目錄
    ##########################################################################
    if                             ( L [ 0 ] == "chdir"                    ) :
      ########################################################################
      self . OsChdir               ( message [ 6 : ]                         )
      ########################################################################
      return True
    ##########################################################################
    ## 改變目錄
    ##########################################################################
    if                             ( L [ 0 ] == "cd"                       ) :
      ########################################################################
      self . OsChdir               ( message [ 3 : ]                         )
      ########################################################################
      return True
    ##########################################################################
    ## 列出檔案
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "ListFiles" ] [ "Allows" ] ) :
      ########################################################################
      threading . Thread           ( target = self . ListFiles   ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    ## 上傳系統
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "CommitSystem" ] [ "Allows" ] ) :
      ########################################################################
      threading . Thread           ( target = self . PushSystem  ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    ## 升級系統
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "UpgradeSystem" ] [ "Allows" ] ) :
      ########################################################################
      threading . Thread           ( target = self . PullSystem  ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    ## 同步系統
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "SyncSystem" ] [ "Allows" ] ) :
      ########################################################################
      threading . Thread           ( target = self . SyncSystem  ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    ## 執行本地命令
    ##########################################################################
    if                             ( L [ 0 ] in [ "dos" , "run" ]          ) :
      ########################################################################
      cmd       = message          [ 4:                                      ]
      threading . Thread           ( target = self . RunCommand            , \
                                     args = ( cmd , )            ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    ## 執行本地命令
    ##########################################################################
    if                             ( L [ 0 ] == "command"                  ) :
      ########################################################################
      cmd       = message          [ 8:                                      ]
      threading . Thread           ( target = self . RunCommand            , \
                                     args = ( cmd , )            ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    ## 載入設定
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "Load" ] [ "Allows" ]     ) :
      if ( CNT > 1 ) and ( L [ 1 ] in self . JSON [ "Commands" ] [ "Settings" ] [ "Allows" ] ) :
        ######################################################################
        threading . Thread         ( target = self . LoadJSON    ) . start ( )
        ######################################################################
        return True
    ##########################################################################
    ## 儲存設定
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "Save" ] [ "Allows" ]     ) :
      if ( CNT > 1 ) and ( L [ 1 ] in self . JSON [ "Commands" ] [ "Settings" ] [ "Allows" ] ) :
        ######################################################################
        threading . Thread         ( target = self . StoreJSON   ) . start ( )
        ######################################################################
        return True
    ##########################################################################
    ## Insider命令儲列
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "CommandQueues" ] [ "Allows" ] ) :
      if ( CNT > 1                                                         ) :
        ######################################################################
        if   ( L [ 1 ] in self . JSON [ "Commands" ] [ "TurnOn"  ] [ "Allows" ] ) :
          ####################################################################
          JSON = {}
          JSON [ "Action" ] = "On"
          self . SendRPC           ( self . tblHost , "Tasks" , JSON         )
          ####################################################################
          return True
        ######################################################################
        if ( L [ 1 ] in self . JSON [ "Commands" ] [ "TurnOff" ] [ "Allows" ] ) :
          ####################################################################
          JSON = {}
          JSON [ "Action" ] = "Off"
          self . SendRPC           ( self . tblHost , "Tasks" , JSON         )
          ####################################################################
          return True
        ######################################################################
        KS  = L [ 0 ]
        KS  = f"{KS} "
        CMD = message [ len(KS): ]
        if                         ( len ( CMD ) > 1                       ) :
          ####################################################################
          JSON = {}
          JSON [ "Action"  ] = "Queue"
          JSON [ "Command" ] = CMD
          JSON [ "Delay"   ] = 3.0
          self . SendRPC           ( self . tblHost , "Tasks" , JSON         )
          ####################################################################
          return True
    ##########################################################################
    return True
  ############################################################################
  def tblMode                      ( self , beau , message                 ) :
    ##########################################################################
    s    = message . lower         (                                         )
    s    = s       . rstrip        (                                         )
    L    = s       . split         ( ' '                                     )
    CNT  = len                     ( L                                       )
    beau = "Lottery"
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Finish" ] [ "Allows" ]         ) :
      ########################################################################
      self . State = 0
      MSG          = self . JSON [ "Commands" ] [ "Finish" ] [ "Welcome" ]
      self . TalkTo                ( beau , MSG                              )
      ########################################################################
      return True
    ##########################################################################
    SERIALID = "Current-Serial"
    if ( s in self . JSON [ "Commands" ] [ SERIALID ] [ "Allows" ]         ) :
      ########################################################################
      JSON = {}
      JSON [ "Action" ] = "Serial"
      R    = self . GetJsonFromRPC  ( self . tblHost , "TBL" , JSON          )
      if                            ( not R                                ) :
        MSG = self . JSON [ "Commands" ] [ SERIALID ] [ "Failure" ]
        self . TalkTo               ( "Lottery" , MSG                        )
      else                                                                   :
        J  = R                      [ "JSON"                                 ]
        self . tblSerial = J        [ "Serial"                               ]
      ########################################################################
      return True
    ##########################################################################
    ASSIGNID = "Assign-Serial"
    if                              ( CNT > 1                              ) :
      if ( L [ 0 ] in self . JSON [ "Commands" ] [ ASSIGNID ] [ "Allows" ] ) :
        ######################################################################
        self . tblSerial = L [ 1 ]
        MSG  = self . JSON [ "Commands" ] [ ASSIGNID ] [ "Current" ]
        MSG  = MSG + self . tblSerial
        self . TalkTo               ( "Lottery" , MSG                        )
        ######################################################################
        return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ ASSIGNID ] [ "Allows" ]         ) :
      ########################################################################
      MSG  = self . JSON [ "Commands" ] [ ASSIGNID ] [ "Failure" ]
      self   . TalkTo               ( "Lottery" , MSG                        )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Prediction" ] [ "Allows" ]     ) :
      ########################################################################
      JSON = {}
      JSON [ "Action" ] = "Prediction"
      self . SendRPC                ( self . tblHost , "TBL" , JSON          )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Rewards" ] [ "Allows" ]        ) :
      ########################################################################
      JSON = {}
      JSON [ "Action" ] = "Rewards"
      self . SendRPC                ( self . tblHost , "TBL" , JSON          )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "CancelBets" ] [ "Allows" ]     ) :
      ########################################################################
      JSON = {}
      JSON [ "Action" ] = "CancelBets"
      JSON [ "Serial" ] = self . tblSerial
      self . SendRPC                ( self . tblHost , "TBL" , JSON          )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "CurrentBets" ] [ "Allows" ]    ) :
      ########################################################################
      JSON = {}
      JSON [ "Action" ] = "CurrentBets"
      self . SendRPC                ( self . tblHost , "TBL" , JSON          )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "PrintBets" ] [ "Allows" ]      ) :
      ########################################################################
      JSON              = { }
      JSON [ "Action" ] = "PrintBets"
      JSON [ "X"      ] = self . tblPaperX
      JSON [ "Y"      ] = self . tblPaperY
      JSON [ "Gap"    ] = self . tblPaperGap
      JSON [ "W"      ] = self . tblPaperW
      JSON [ "H"      ] = self . tblPaperH
      JSON [ "L"      ] = self . tblPaperL
      JSON [ "Text"   ] = self . tblPaperText
      self . SendRPC                ( self . tblHost , "TBL" , JSON          )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Bettings" ] [ "Allows" ]       ) :
      ########################################################################
      self . State = 12
      if ( len ( L ) > 1 ) :
        self . tblSerial = L [ 1 ]
      ########################################################################
      return True
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "Paper" ] [ "Allows" ]    ) :
      if                            ( CNT == 8                             ) :
        ######################################################################
        self . tblPaperX    = float ( L [ 1 ]                                )
        self . tblPaperY    = float ( L [ 2 ]                                )
        self . tblPaperGap  = float ( L [ 3 ]                                )
        self . tblPaperW    = float ( L [ 4 ]                                )
        self . tblPaperH    = float ( L [ 5 ]                                )
        self . tblPaperL    = float ( L [ 6 ]                                )
        self . tblPaperText = float ( L [ 7 ]                                )
        ######################################################################
        self . JSON [ "Paper" ] [ "X"      ] = self . tblPaperX
        self . JSON [ "Paper" ] [ "Y"      ] = self . tblPaperY
        self . JSON [ "Paper" ] [ "Gap"    ] = self . tblPaperGap
        self . JSON [ "Paper" ] [ "Width"  ] = self . tblPaperW
        self . JSON [ "Paper" ] [ "Height" ] = self . tblPaperH
        self . JSON [ "Paper" ] [ "Length" ] = self . tblPaperL
        self . JSON [ "Paper" ] [ "Text"   ] = self . tblPaperText
        ######################################################################
        self . StoreJSON (                                                   )
        ######################################################################
        MSG  = "已經儲存紙張設定"
        self . TalkTo               ( "Lottery" , MSG                        )
        return True
        ######################################################################
      else                                                                   :
        ######################################################################
        CMD = self . JSON [ "Commands" ] [ "Paper" ] [ "Comment" ]
        X   = self . tblPaperX
        Y   = self . tblPaperY
        GAP = self . tblPaperGap
        W   = self . tblPaperW
        H   = self . tblPaperH
        L   = self . tblPaperL
        T   = self . tblPaperText
        MSG = f"{CMD}\n\nX偏移植：{X} mm\nY偏移植：{Y} mm\nGap每區間隔：{GAP} mm\nWidth每格間隔：{W} mm\nHeight高度間隔：{H} mm\nLength填充長度：{L} mm\nText文字高度：{T} mm"
        self   . TalkTo             ( "Lottery" , MSG                        )
        ######################################################################
        return True
    ##########################################################################
    return True
  ############################################################################
  def tblBettings                  ( self , beau , message                 ) :
    ##########################################################################
    self . State        = 11
    JSON                = { }
    JSON [ "Action"   ] = "Bettings"
    JSON [ "Serial"   ] = self . tblSerial
    JSON [ "Bettings" ] = message
    self . SendRPC                  ( self . tblHost , "TBL" , JSON          )
    ##########################################################################
    return True
  ############################################################################
  def StartCalendar                       ( self                           ) :
    ##########################################################################
    self . State = 21
    MSG  = self . JSON [ "Commands" ] [ "Calendars" ] [ "Welcome" ]
    self . TalkTo                         ( self . Beau , MSG                )
    ##########################################################################
    if                                    ( self . Scheduler == None       ) :
      self . Scheduler = ScheduleNotifier ( self . CalendarsFile             )
      self . Scheduler . Talk        = self . Talk
      self . Scheduler . DebugLogger = self . DebugLogger
      self . Scheduler . Start            (                                  )
    ##########################################################################
    return
  ############################################################################
  def CalendarMode                 ( self , beau , message                 ) :
    ##########################################################################
    s    = message . lower         (                                         )
    s    = s       . rstrip        (                                         )
    L    = s       . split         ( ' '                                     )
    CNT  = len                     ( L                                       )
    beau = "Calendars"
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "Finish" ] [ "Allows" ]         ) :
      ########################################################################
      self . State = 0
      MSG          = self . JSON [ "Commands" ] [ "Finish" ] [ "Welcome" ]
      self . TalkTo                ( beau , MSG                              )
      ########################################################################
      return True
    ##########################################################################
    if                             ( self . Scheduler == None              ) :
      return False
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "CalendarList" ] [ "Allows" ]   ) :
      ########################################################################
      threading . Thread ( target = self . Scheduler . ReportCalendars ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "CurrentCalendar" ] [ "Allows" ] ) :
      ########################################################################
      threading . Thread ( target = self . Scheduler . ReportCurrentCalendar ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    if ( s in self . JSON [ "Commands" ] [ "CurrentPeriods" ] [ "Allows" ] )  :
      ########################################################################
      threading . Thread ( target = self . Scheduler . ReportCurrentPeriods ) . start ( )
      ########################################################################
      return True
    ##########################################################################
    if                             ( CNT < 2                               ) :
      return False
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "PickCalendar" ] [ "Allows" ] ) :
      ########################################################################
      try                                                                    :
        ID = int ( L [ 1 ] )
        threading . Thread ( target = self . Scheduler . PickCalendar      , \
                             args   = ( ID , )                   ) . start ( )
        return True
      except                                                                 :
        return False
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "Load" ] [ "Allows" ] )     :
      ########################################################################
      pass
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "Save" ] [ "Allows" ] )     :
      ########################################################################
      pass
    ##########################################################################
    if   ( L [ 0 ] in self . JSON [ "Commands" ] [ "Append" ] [ "Allows" ] ) :
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Period" ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . AppendCurrentPeriod ) . start ( )
        return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Event" ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . AppendCurrentEvent ) . start ( )
        return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Task" ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . AppendCurrentTask ) . start ( )
        return True
    ##########################################################################
    if   ( L [ 0 ] in self . JSON [ "Commands" ] [ "Assign" ] [ "Allows" ] ) :
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Period" ] [ "Allows" ] ) :
        if ( CNT > 2 )                                                       :
          threading . Thread ( target = self . Scheduler . AssignCurrentPeriod , \
                               args   = ( L [ 2 ] , )            ) . start ( )
          return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Event" ] [ "Allows" ] ) :
        if ( CNT > 2 )                                                       :
          threading . Thread ( target = self . Scheduler . AssignCurrentEvent , \
                               args   = ( L [ 2 ] , )            ) . start ( )
          return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Task" ] [ "Allows" ] ) :
        if ( CNT > 2 )                                                       :
          threading . Thread ( target = self . Scheduler . AssignCurrentTask , \
                               args   = ( L [ 2 ] , )            ) . start ( )
          return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "StartTime" ] [ "Allows" ] ) :
        if ( CNT > 2 )                                                       :
          TT = L [ 2 ]
          if ( CNT > 3 ) :
            TT = TT + " " + L [ 3 ]
          threading . Thread ( target = self . Scheduler . AssignStartTime , \
                               args   = ( TT , )                 ) . start ( )
          return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "EndTime" ] [ "Allows" ] ) :
        if ( CNT > 2 )                                                       :
          TT = L [ 2 ]
          if ( CNT > 3 ) :
            TT = TT + " " + L [ 3 ]
          threading . Thread ( target = self . Scheduler . AssignEndTime ,   \
                               args   = ( TT , )                 ) . start ( )
          return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Title" ] [ "Allows" ] ) :
        self . State = 22
        return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Description" ] [ "Allows" ] ) :
        self . State = 23
        return True
    ##########################################################################
    if   ( L [ 0 ] in self . JSON [ "Commands" ] [ "SyncSystem" ] [ "Allows" ] ) :
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Periods"    ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . SyncPeriods ) . start ( )
        return True
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "TurnOn"  ] [ "Allows" ] )  :
      ########################################################################
      pass
    ##########################################################################
    if ( L [ 0 ] in self . JSON [ "Commands" ] [ "TurnOff" ] [ "Allows" ] )  :
      ########################################################################
      pass
    ##########################################################################
    if   ( L [ 0 ] in self . JSON [ "Commands" ] [ "Current" ] [ "Allows" ] ) :
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Period"  ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . ReportCurrentPeriod ) . start ( )
        return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Periods" ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . ReportCurrentPeriods ) . start ( )
        return True
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Settings"  ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . ReportCurrentSettings ) . start ( )
        return True
    ##########################################################################
    if   ( L [ 0 ] in self . JSON [ "Commands" ] [ "Clear"    ] [ "Allows" ] ) :
      ########################################################################
      if ( L [ 1 ] in self . JSON [ "Commands" ] [ "Settings" ] [ "Allows" ] ) :
        threading . Thread ( target = self . Scheduler . ClearCurrentSettings ) . start ( )
        return True
    ##########################################################################
    return True
  ############################################################################
  def CalendarTitle                ( self , beau , message                 ) :
    ##########################################################################
    self . State        = 21
    self . Scheduler . CurrentTitle = message
    ##########################################################################
    return True
  ############################################################################
  def CalendarDescription          ( self , beau , message                 ) :
    ##########################################################################
    self . State        = 21
    self . Scheduler . CurrentDescription = message
    ##########################################################################
    return True
  ############################################################################
  def OsGetCWD                      ( self                                 ) :
    ##########################################################################
    self . CurrentDir = os . getcwd (                                        )
    self . TalkTo                   ( self . Beau , self . CurrentDir        )
    ##########################################################################
    return
  ############################################################################
  def OsChdir                       ( self , directory                     ) :
    ##########################################################################
    os   . chdir                    (        directory                       )
    self . OsGetCWD                 (                                        )
    ##########################################################################
    return
  ############################################################################
  def ListFiles                     ( self                                 ) :
    ##########################################################################
    L     = "\n" . join ( [ f for f in os . listdir ( ) ] )
    T     = L
    self . TalkTo                   ( "files" , T                            )
    ##########################################################################
    return
  ############################################################################
  def GetJsonFromRPC           ( self , HOST , Command , JSON              ) :
    ##########################################################################
    CMD      = f"{HOST}/{Command}"
    Headers  = { "Username" : "foxman"                                       ,
                 "Password" : "actionsfox2019"                               }
    try                                                                      :
      status = requests . post ( CMD                                         ,
                                 data    = json . dumps ( JSON )             ,
                                 headers = Headers                           )
    except                                                                   :
      return False
    ##########################################################################
    KK       = status . text
    KK       = KK . replace    ( "'" , "\""                                  )
    ##########################################################################
    return { "Status" : status . status_code                                 ,
             "JSON"   : json . loads ( KK )                                  }
  ############################################################################
  def SendRPC                       ( self , HOST , Command , JSON         ) :
    ##########################################################################
    CMD      = f"{HOST}/{Command}"
    Headers  = { "Username" : "foxman"                                       ,
                 "Password" : "actionsfox2019"                               }
    try                                                                      :
      status = requests . post ( CMD                                         ,
                                 data    = json . dumps ( JSON )             ,
                                 headers = Headers                           )
    except                                                                   :
      return False
    ##########################################################################
    return status . status_code
  ############################################################################
  def PullSystem                    ( self                                 ) :
    return self . RunCommand        ( self . PullCommand                     )
  ############################################################################
  def PushSystem                    ( self                                 ) :
    ##########################################################################
    return self . RunCommand        ( self . PushCommand                     )
  ############################################################################
  def SyncSystem                    ( self                                 ) :
    ##########################################################################
    self . RunCommand               ( self . PushCommand                     )
    self . RunCommand               ( self . PullCommand                     )
    ##########################################################################
    return
  ############################################################################
  def RunCommand                       ( self , command                    ) :
    ##########################################################################
    if                                 ( len ( command ) <= 0              ) :
      return
    ##########################################################################
    r = subprocess . Popen             ( command                           , \
                                        shell  = True                      , \
                                        stdout = subprocess . PIPE         , \
                                        stderr = subprocess . STDOUT         )
    L = r . stdout . readlines         (                                     )
    r . stdout . close                 (                                     )
    ##########################################################################
    X     = [ ]
    for S in L                                                               :
      X   . append                     ( S . decode ( "utf-8" )              )
    T     = "" . join                  ( X                                   )
    ##########################################################################
    self  . TalkTo                     ( "command" , T                       )
    ##########################################################################
    return
##############################################################################
