# -*- coding: utf-8 -*-
##############################################################################
## 曆法
##############################################################################
import  json
##############################################################################
from .. Base      import Base      as Base
from .. Formatter import Formatter as Formatter
from .. Parser    import Parser    as Parser
##############################################################################
class TaudFormatter      ( Formatter                                       ) :
  ############################################################################
  def __init__           ( self                                            ) :
    ##########################################################################
    super ( ) . __init__ (                                                   )
    ##########################################################################
    return
  ############################################################################
  def toString                ( self , Calendar , Format                   ) :
    ##########################################################################
    V   = Calendar . Value
    R   = Calendar . Remain
    N   = Calendar . Norm
    S   = Format
    ##########################################################################
    if                        ( "%T" in S                                  ) :
      ########################################################################
      S = S     . replace     ( "%T" , f"{V}"                                )
    ##########################################################################
    if                        ( "%R" in S                                  ) :
      ########################################################################
      S = S     . replace     ( "%R" , f"{R}"                                )
    ##########################################################################
    S   = self  . toRemainDay ( S , N                                        )
    ##########################################################################
    return self . toHMS       ( S , R                                        )
##############################################################################
class TaudParser         ( Parser                                          ) :
  ############################################################################
  def __init__           ( self                                            ) :
    ##########################################################################
    super ( ) . __init__ (                                                   )
    ##########################################################################
    return
  ############################################################################
  def Decoder                 ( self , Calendar , inputString , Format     ) :
    ##########################################################################
    ##########################################################################
    ##########################################################################
    ##########################################################################
    ##########################################################################
    return True
##############################################################################
class TAUD                       ( Base                                    ) :
  ############################################################################
  def __init__                   ( self                                    ) :
    ##########################################################################
    super ( ) . __init__         (                                           )
    ##########################################################################
    self      . Value  = 0
    self      . Remain = 0
    self      . Norm   = 0.0
    ##########################################################################
    self      . setFormat        ( "TAUD(%T) %H:%M:%S"                       )
    self      . InstallFormatter ( TaudFormatter ( )                         )
    self      . InstallParser    ( TaudParser    ( )                         )
    ##########################################################################
    return
  ############################################################################
  def __del__      ( self                                                  ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  def __str__              ( self                                          ) :
    return self . toString (                                                 )
  ############################################################################
  def __repr__          ( self                                             ) :
    return json . dumps ( self . toJson ( )                                  )
  ############################################################################
  def typeString ( self                                                    ) :
    return "TAUD"
  ############################################################################
  def valueChanged          ( self                                         ) :
    ##########################################################################
    self   . Value  = 0
    self   . Remain = 0
    self   . Norm   = 0.0
    ##########################################################################
    try                                                                      :
      ########################################################################
      self . Value  = int   ( self . Stardate / 86400                        )
      self . Remain = int   ( self . Stardate % 86400                        )
      self . Norm   = float ( float ( self . Remain ) / 86400.0              )
      ########################################################################
    except                                                                   :
      pass
    ##########################################################################
    return
  ############################################################################
  def toJson ( self                                                        ) :
    return   { "Type"      : "TAUD"                                        , \
               "Signature" : self . Signature                              , \
               "StarDate"  : self . Stardate                               , \
               "TimeZone"  : self . TimeZone                               , \
               "Format"    : self . Format                                 , \
               "TAUD"      : self . Value                                  , \
               "Remain"    : self . Remain                                 , \
               "Norm"      : self . Norm                                     }
  ############################################################################
  def toString                  ( self , format = ""                       ) :
    ##########################################################################
    MOD   = self . defaultFormatter
    ##########################################################################
    if                          ( MOD in [ False , None ]                  ) :
      raise ModuleNotFoundError (                                            )
    ##########################################################################
    FMT   = format
    if                          ( len ( FMT ) <= 0                         ) :
      FMT = self . Format
    ##########################################################################
    return MOD . toString       ( self , FMT                                 )
  ############################################################################
  def fromString                ( self , inputString , format = ""         ) :
    ##########################################################################
    MOD   = self . defaultParser
    ##########################################################################
    if                          ( MOD in [ False , None ]                  ) :
      raise ModuleNotFoundError (                                            )
    ##########################################################################
    FMT   = format
    if                          ( len ( FMT ) <= 0                         ) :
      FMT = self . Format
    ##########################################################################
    return MOD . Decoder        ( self , inputString , FMT                   )
  ############################################################################
  def setValue             ( self , key , value                            ) :
    ##########################################################################
    K        = key
    K        = K . lower   (                                                 )
    ##########################################################################
    self     . Value  = 0
    self     . Remain = 0
    self     . Norm   = 0.0
    ##########################################################################
    if                     ( key in [ "taud" , "value" , "t" ]             ) :
      ########################################################################
      try                                                                    :
        ######################################################################
        V    = int         ( value                                           )
        self . Value  = V
        ######################################################################
      except                                                                 :
        pass
    ##########################################################################
    if                     ( key in [ "remain" , "r" ]                     ) :
      ########################################################################
      try                                                                    :
        ######################################################################
        V    = int         ( value                                           )
        self . Remain  = V
        ######################################################################
      except                                                                 :
        pass
    ##########################################################################
    SD       = int         ( int ( self . Value * 86400 ) + self . Remain    )
    self     . setStarDate ( SD                                              )
    ##########################################################################
    return self . Stardate
  ############################################################################
  def getValue      ( self , key                                           ) :
    ##########################################################################
    K = key
    K = K . lower   (                                                        )
    ##########################################################################
    if              ( key in [ "taud" , "value" , "t"                    ] ) :
      return int    ( self . Value                                           )
    ##########################################################################
    if              ( key in [ "remain" , "r"                            ] ) :
      return int    ( self . Remain                                          )
    ##########################################################################
    raise NameError (                                                        )
##############################################################################
