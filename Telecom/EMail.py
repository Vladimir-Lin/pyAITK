# -*- coding: utf-8 -*-
##############################################################################
## 電子郵件
##############################################################################
import os
import sys
##############################################################################
import mysql . connector
from   mysql . connector             import Error
##############################################################################
from   ..      Database . Query      import Query      as Query
from   ..      Database . Connection import Connection as Connection
from   ..      Database . Columns    import Columns    as Columns
##############################################################################
class EMail              ( Columns                                         ) :
  ############################################################################
  def __init__           ( self                                            ) :
    ##########################################################################
    super ( ) . __init__ (                                                   )
    self . Clear         (                                                   )
    ##########################################################################
    return
  ############################################################################
  def __del__            ( self                                            ) :
    return
  ############################################################################
  def Clear              ( self                                            ) :
    ##########################################################################
    self . Columns  =    [                                                   ]
    self . Id       = -1
    self . Uuid     =  0
    self . HostId   =  0
    self . Account  =  ""
    self . Hostname =  ""
    self . EMail    =  ""
    self . ltime    =  False
    ##########################################################################
    return
  ############################################################################
  def assign             ( self , item                                     ) :
    ##########################################################################
    self . Columns  = item . Columns
    self . Id       = item . Id
    self . Uuid     = item . Uuid
    self . HostId   = item . HostId
    self . Account  = item . Account
    self . Hostname = item . Hostname
    self . EMail    = item . EMail
    self . ltime    = item . ltime
    ##########################################################################
    return
  ############################################################################
  def set                   ( self , item , value                          ) :
    ##########################################################################
    a      = item . lower   (                                                )
    ##########################################################################
    if                      ( "id"       == a                              ) :
      self . Id       = int ( value                                          )
    if                      ( "uuid"     == a                              ) :
      self . Uuid     = int ( value                                          )
    if                      ( "hostid"   == a                              ) :
      self . HostId   = int ( value                                          )
    if                      ( "account"  == a                              ) :
      self . Account  = str ( value                                          )
    if                      ( "hostname" == a                              ) :
      self . Hostname = str ( value                                          )
    if                      ( "email"    == a                              ) :
      self . EMail    = str ( value                                          )
    if                      ( "ltime"    == a                              ) :
      self . ltime    = value
    ##########################################################################
    return
  ############################################################################
  def get                   ( self , item                                  ) :
    ##########################################################################
    a = item . lower        (                                                )
    ##########################################################################
    if                      ( "id"       == a                              ) :
      return int            ( self . Id                                      )
    if                      ( "uuid"     == a                              ) :
      return int            ( self . Uuid                                    )
    if                      ( "hostid"   == a                              ) :
      return int            ( self . HostId                                  )
    if                      ( "account"  == a                              ) :
      return str            ( self . Account                                 )
    if                      ( "hostname" == a                              ) :
      return str            ( self . Hostname                                )
    if                      ( "email"    == a                              ) :
      return str            ( self . EMail                                   )
    if                      ( "ltime"    == a                              ) :
      return self . ltime
    ##########################################################################
    return ""
  ############################################################################
  def tableItems ( self                                                    ) :
    return       [ "id"                                                    , \
                   "uuid"                                                  , \
                   "hostid"                                                , \
                   "account"                                               , \
                   "hostname"                                              , \
                   "email"                                                 , \
                   "ltime"                                                   ]
  ############################################################################
  def pair           ( self , item                                         ) :
    ##########################################################################
    a = item . lower (                                                       )
    v = self . get   ( item                                                  )
    ##########################################################################
    if               ( "id"       == a                                     ) :
      return f"`{item}` = {v}"
    if               ( "uuid"     == a                                     ) :
      return f"`{item}` = {v}"
    if               ( "hostid"   == a                                     ) :
      return f"`{item}` = {v}"
    if               ( "account"  == a                                     ) :
      return f"`{item}` = '{v}'"
    if               ( "hostname" == a                                     ) :
      return f"`{item}` = '{v}'"
    if               ( "email"    == a                                     ) :
      return f"`{item}` = '{v}'"
    if               ( "ltime"    == a                                     ) :
      return f"`{item}` = '{v}'"
    ##########################################################################
    return f"`{item}` = {v}"
  ############################################################################
  def valueItems ( self                                                    ) :
    return       [ "hostid"                                                , \
                   "account"                                               , \
                   "hostname"                                              , \
                   "email"                                                   ]
  ############################################################################
  def toJson ( self                                                        ) :
    return   { "id"       : self . Id                                      , \
               "uuid"     : self . Uuid                                    , \
               "hostid"   : self . HostId                                  , \
               "account"  : self . Account                                 , \
               "hostname" : self . Hostname                                , \
               "email"    : self . EMail                                   , \
               "ltime"    : self . Update                                    }
  ############################################################################
  def hasSpecialChar ( self , MSG                                          ) :
    ##########################################################################
    KEYs =           [ "@"                                                 , \
                       " "                                                 , \
                       "'"                                                 , \
                       "\""                                                , \
                       "%"                                                 , \
                       "`"                                                 , \
                       ":"                                                 , \
                       "/"                                                 , \
                       "\\"                                                  ]
    for K in KEYs                                                            :
      if             ( K in MSG                                            ) :
        return True
    ##########################################################################
    return False
  ############################################################################
  ## 檢查是否為有效電子郵件主機
  ############################################################################
  def isValidHostname   ( self , host                                      ) :
    ##########################################################################
    if                  ( len ( host ) <= 0                                ) :
      return   False
    ##########################################################################
    if                  ( "@"     in host                                  ) :
      return   False
    ##########################################################################
    if                  ( "." not in host                                  ) :
      return   False
    ##########################################################################
    H    = host . split ( "."                                                )
    if                  ( len ( H ) < 2                                    ) :
      return   False
    ##########################################################################
    for T in H                                                               :
      ########################################################################
      if              ( len ( T ) <= 0                                     ) :
        return False
      ########################################################################
      if              ( self . hasSpecialChar ( T )                        ) :
        return False
    ##########################################################################
    return     True
  ############################################################################
  ## 檢查是否為有效電子郵件帳號
  ############################################################################
  def isValidAccount ( self , account                                      ) :
    ##########################################################################
    if               ( len ( account ) <= 0                                ) :
      return False
    ##########################################################################
    if               ( self . hasSpecialChar ( account )                   ) :
      return False
    ##########################################################################
    return   True
  ############################################################################
  ## 檢查是否為有效完整電子郵件帳號
  ############################################################################
  def isValidEMail           ( self , email                                ) :
    ##########################################################################
    if                       ( len ( email ) <= 0                          ) :
      return False
    ##########################################################################
    if                       ( "@" not in email                            ) :
      return False
    ##########################################################################
    L        = email . split ( "@"                                           )
    if                       ( len ( L ) != 2                              ) :
      return False
    ##########################################################################
    ACCOUNT  = L             [ 0                                             ]
    HOSTNAME = L             [ 1                                             ]
    ##########################################################################
    if                       ( not self . isValidAccount  ( ACCOUNT  )     ) :
      return False
    ##########################################################################
    if                       ( not self . isValidHostname ( HOSTNAME )     ) :
      return False
    ##########################################################################
    return   True
  ############################################################################
  def setAccount             ( self , account                              ) :
    ##########################################################################
    if                       ( not self . isValidAccount  ( account  )     ) :
      return False
    ##########################################################################
    self . Account = account
    ##########################################################################
    A              = account
    H              = self . Hostname
    self . EMail   = f"{A}@{H}"
    ##########################################################################
    return True
  ############################################################################
  def setHostname            ( self , hostname                             ) :
    ##########################################################################
    if                       ( not self . isValidHostname ( hostname )     ) :
      return False
    ##########################################################################
    self . Hostname = hostname
    ##########################################################################
    A              = self . Account
    H              = hostname
    self . EMail   = f"{A}@{H}"
    ##########################################################################
    return True
  ############################################################################
  def setEMail                  ( self , email                             ) :
    ##########################################################################
    if                          ( not self . isValidEMail ( email )        ) :
      return False
    ##########################################################################
    E               = email
    L               = E . split ( "@"                                        )
    self . EMail    = email
    ##########################################################################
    self . Account  = L         [ 0                                          ]
    self . Hostname = L         [ 1                                          ]
    ##########################################################################
    return True
##############################################################################
