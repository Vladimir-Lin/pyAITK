# -*- coding: utf-8 -*-
##############################################################################
## VtkModel
##############################################################################
import os
import sys
import getopt
import time
import requests
import threading
import gettext
import json
import math
import shutil
import vtk
##############################################################################
from   PyQt5                                  import QtCore
from   PyQt5                                  import QtGui
from   PyQt5                                  import QtWidgets
##############################################################################
from   PyQt5 . QtCore                         import QObject
from   PyQt5 . QtCore                         import pyqtSignal
from   PyQt5 . QtCore                         import pyqtSlot
from   PyQt5 . QtCore                         import Qt
from   PyQt5 . QtCore                         import QPoint
from   PyQt5 . QtCore                         import QPointF
from   PyQt5 . QtCore                         import QSize
##############################################################################
from   PyQt5 . QtGui                          import QIcon
from   PyQt5 . QtGui                          import QCursor
from   PyQt5 . QtGui                          import QColor
from   PyQt5 . QtGui                          import QKeySequence
##############################################################################
from   PyQt5 . QtWidgets                      import QApplication
from   PyQt5 . QtWidgets                      import qApp
from   PyQt5 . QtWidgets                      import QWidget
from   PyQt5 . QtWidgets                      import QFileDialog
from   PyQt5 . QtWidgets                      import QSpinBox
from   PyQt5 . QtWidgets                      import QDoubleSpinBox
##############################################################################
from   AITK  . Documents . JSON               import Load         as LoadJson
from   AITK  . Documents . JSON               import Save         as SaveJson
##############################################################################
from   AITK  . VTK . VtkWidget                import VtkWidget    as VtkWidget
from   AITK  . VTK . Wrapper                  import Wrapper      as VtkWrapper
##############################################################################
from   AITK  . Qt  . MenuManager              import MenuManager  as MenuManager
from   AITK  . Qt  . LineEdit                 import LineEdit     as LineEdit
from   AITK  . Qt  . ComboBox                 import ComboBox     as ComboBox
from   AITK  . Qt  . SpinBox                  import SpinBox      as SpinBox
##############################################################################
from   AITK  . Math . Geometry . ControlPoint import ControlPoint as ControlPoint
from   AITK  . Math . Geometry . Contour      import Contour      as Contour
from   AITK  . Math . Geometry . Circle       import Circle       as Circle
from   AITK  . Math . Geometry . Cylinder     import Cylinder     as Cylinder
from   AITK  . Math . Geometry . Plane        import Plane        as Plane
from   AITK  . Math . Geometry . Parabola     import Parabola     as Parabola
from   AITK  . Math . Geometry . Sphere       import Sphere       as Sphere
from   AITK  . Math . Geometry . Polyhedron   import Polyhedron   as Polyhedron
##############################################################################
from   AITK  . Models . AitkModel             import Model        as ModelJson
##############################################################################
from         . VtkModelPad                    import VtkModelPad
##############################################################################
class VtkModel                 ( VtkWidget                                 ) :
  ############################################################################
  emitStartModel = pyqtSignal  (                                             )
  emitStartJson  = pyqtSignal  (                                             )
  ############################################################################
  def __init__                 ( self , parent = None , plan = None        ) :
    ##########################################################################
    super ( ) . __init__       (        parent        , plan                 )
    self . setVtkModelDefaults (                                             )
    ##########################################################################
    return
  ############################################################################
  def sizeHint                   ( self                                    ) :
    return self . SizeSuggestion ( QSize ( 640 , 640 )                       )
  ############################################################################
  def setVtkModelDefaults   ( self                                         ) :
    ##########################################################################
    self . dockingOrientation = 0
    self . dockingPlace       = Qt . RightDockWidgetArea
    ##########################################################################
    self . Uuid               = 0
    self . LOID               = 0
    self . LodName            = ""
    self . Mouse              = False
    self . Pad                = False
    self . PadUi              = None
    self . AitkJSON           = {                                            }
    self . ActorsMapper       = {                                            }
    ##########################################################################
    self . setFunction      ( self . HavingMenu      , True                  )
    ##########################################################################
    self . setAcceptDrops   ( False                                          )
    ## self . setDragEnabled   ( False                                          )
    ## self . setDragDropMode  ( QAbstractItemView . NoDragDrop                 )
    ##########################################################################
    self . emitStartModel . connect ( self . StartModel                      )
    self . emitStartJson  . connect ( self . StartJson                       )
    ##########################################################################
    self . setPrepared      ( True                                           )
    ##########################################################################
    return
  ############################################################################
  def AttachActions   ( self ,                         Enabled             ) :
    ##########################################################################
    self . LinkAction ( "Save"   , self . ExportVTK  , Enabled               )
    self . LinkAction ( "Export" , self . ExportJSON , Enabled               )
    ##########################################################################
    return
  ############################################################################
  def wheelEvent              ( self , event                               ) :
    ##########################################################################
    if                        ( self . handleMouse ( 4 , event )           ) :
      return
    ##########################################################################
    super ( ) . wheelEvent    (     event                                    )
    self      . dealWithMouse ( 4 , event                                    )
    ##########################################################################
    return
  ############################################################################
  def mouseDoubleClickEvent           ( self , event                       ) :
    ##########################################################################
    if                                ( self . handleMouse ( 3 , event )   ) :
      return
    ##########################################################################
    super ( ) . mouseDoubleClickEvent (     event                            )
    self      . dealWithMouse         ( 3 , event                            )
    ##########################################################################
    return
  ############################################################################
  def mouseMoveEvent           ( self , event                              ) :
    ##########################################################################
    if                         ( self . handleMouse ( 2 , event )          ) :
      return
    ##########################################################################
    super ( ) . mouseMoveEvent (     event                                   )
    self      . dealWithMouse  ( 2 , event                                   )
    ##########################################################################
    return
  ############################################################################
  def mouseReleaseEvent           ( self , event                           ) :
    ##########################################################################
    if                          ( self . handleMouse ( 1 , event )         ) :
      return
    ##########################################################################
    super ( ) . mouseReleaseEvent (     event                                )
    self      . dealWithMouse     ( 1 , event                                )
    ##########################################################################
    return
  ############################################################################
  def mousePressEvent           ( self , event                             ) :
    ##########################################################################
    if                          ( self . handleMouse ( 0 , event )         ) :
      return
    ##########################################################################
    super ( ) . mousePressEvent (     event                                  )
    self      . dealWithMouse   ( 0 , event                                  )
    ##########################################################################
    return
  ############################################################################
  def handleMouse   ( self , mType , event                                 ) :
    ##########################################################################
    if              ( self . Mouse                                         ) :
      return False
    ##########################################################################
    event . accept  (                                                        )
    ##########################################################################
    return True
  ############################################################################
  def dealWithMouse                 ( self , mType , event                 ) :
    ##########################################################################
    if                              ( self . Pad                           ) :
      ########################################################################
      if                            ( mType in [ 4 ]                       ) :
        ######################################################################
        self . PadUi . UpdateCamera (                                        )
        ######################################################################
      elif ( self . isBitMask ( event . buttons ( ) , Qt . LeftButton )    ) :
        ######################################################################
        self . PadUi . UpdateCamera (                                        )
    ##########################################################################
    return
  ############################################################################
  def Relocation                  ( self                                   ) :
    ##########################################################################
    if                            ( self . Pad                             ) :
      ########################################################################
      self . PadUi . UpdateCamera (                                          )
    ##########################################################################
    return False
  ############################################################################
  def Shutdown           ( self                                            ) :
    ##########################################################################
    self . Leave . emit  ( self                                              )
    ## self . AttachActions ( False                                             )
    ##########################################################################
    return True
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  def PrepareVtkPoints       ( self , START , TOTAL , POINTs               ) :
    ##########################################################################
    P    = vtk . vtkPoints   (                                               )
    P    . SetNumberOfPoints ( TOTAL                                         )
    ##########################################################################
    id   = START
    ##########################################################################
    for PT in POINTs                                                         :
      ########################################################################
      P  . SetPoint          ( id , PT                                       )
      ########################################################################
      id = id + 1
    ##########################################################################
    return P
  ############################################################################
  def PrepareVtkPolygon                      ( self , EDGEs                ) :
    ##########################################################################
    TOTAL = len                              ( EDGEs                         )
    AT    = 0
    ##########################################################################
    P     = vtk . vtkPolygon                 (                               )
    P     . GetPointIds ( ) . SetNumberOfIds ( TOTAL                         )
    ##########################################################################
    while                                    ( AT < TOTAL                  ) :
      ########################################################################
      P   . GetPointIds ( ) . SetId          ( AT , EDGEs [ AT ]             )
      ########################################################################
      AT  = AT + 1
    ##########################################################################
    return P
  ############################################################################
  def PrepareVtkPolygons              ( self , FACEs                       ) :
    ##########################################################################
    POLY   = vtk . vtkCellArray       (                                      )
    ##########################################################################
    for FACE in FACEs                                                        :
      ########################################################################
      P    = self . PrepareVtkPolygon ( FACE                                 )
      POLY . InsertNextCell           ( P                                    )
    ##########################################################################
    return POLY
  ############################################################################
  def CreateActorFromJson                   ( self , ACTOR                 ) :
    ##########################################################################
    m      = ModelJson                      (                                )
    ##########################################################################
    TPTS   = ACTOR                          [ "TotalPoints"                  ]
    TFACE  = ACTOR                          [ "TotalFaces"                   ]
    POINTS = ACTOR                          [ "Points"                       ]
    FACES  = ACTOR                          [ "Faces"                        ]
    ##########################################################################
    ACT    = vtk . vtkActor                 (                                )
    PLM    = vtk . vtkPolyDataMapper        (                                )
    PLD    = vtk . vtkPolyData              (                                )
    ##########################################################################
    ACT    . SetMapper                      ( PLM                            )
    ACT    . GetProperty ( ) . SetPointSize ( 1                              )
    ##########################################################################
    VPTS   = self . PrepareVtkPoints        ( 0 , TPTS , POINTS              )
    POLY   = self . PrepareVtkPolygons      ( FACES                          )
    ##########################################################################
    PLD    . SetPoints                      ( VPTS                           )
    PLD    . SetPolys                       ( POLY                           )
    PLD    . Modified                       (                                )
    ##########################################################################
    PLM   . SetInputData                    ( PLD                            )
    ##########################################################################
    self  . renderer . AddActor             ( ACT                            )
    ##########################################################################
    return
  ############################################################################
  def PrepareForJSON              ( self                                   ) :
    ##########################################################################
    self   . ClearActors          (                                          )
    ##########################################################################
    TOTAL  = self . AitkJSON      [ "TotalActors"                            ]
    ##########################################################################
    if                            ( TOTAL <= 0                             ) :
      return
    ##########################################################################
    AT     = 0
    ##########################################################################
    while                         ( AT < TOTAL                             ) :
      ########################################################################
      ACT  = self . AitkJSON      [ "Actors" ] [ f"{AT}"                     ]
      ########################################################################
      self . CreateActorFromJson  ( ACT                                      )
      ########################################################################
      AT   = AT + 1
    ##########################################################################
    self   . emitStartJson . emit (                                          )
    ##########################################################################
    return
  ############################################################################
  def StartModel                    ( self                                 ) :
    ##########################################################################
    self . renderer   . ResetCamera (                                        )
    self . interactor . Initialize  (                                        )
    self . interactor . Start       (                                        )
    ##########################################################################
    self . ToAitkJSON               ( False                                  )
    ##########################################################################
    self . Notify                   ( 5                                      )
    ##########################################################################
    return
  ############################################################################
  def StartJson                     ( self                                 ) :
    ##########################################################################
    self . renderer   . ResetCamera (                                        )
    self . interactor . Initialize  (                                        )
    self . interactor . Start       (                                        )
    ##########################################################################
    self . Notify                   ( 5                                      )
    ##########################################################################
    return
  ############################################################################
  def toJSON               ( self , TEXT                                   ) :
    ##########################################################################
    if                     ( len ( TEXT ) <= 0                             ) :
      return               {                                                 }
    ##########################################################################
    try                                                                      :
      BODY = TEXT . decode ( "utf-8"                                         )
    except                                                                   :
      return               {                                                 }
    ##########################################################################
    if                     ( len ( BODY ) <= 0                             ) :
      return               {                                                 }
    ##########################################################################
    return json . loads    ( BODY                                            )
  ############################################################################
  def loading                        ( self                                ) :
    ##########################################################################
    if                               ( self . LOID <= 0                    ) :
      ########################################################################
      self   . emitStartModel . emit (                                       )
      ########################################################################
      return
    ##########################################################################
    DB       = self . ConnectDB      (                                       )
    if                               ( DB == None                          ) :
      ########################################################################
      self   . emitStartModel . emit (                                       )
      ########################################################################
      return
    ##########################################################################
    OKAY     = False
    self     . Notify                ( 3                                     )
    ##########################################################################
    FMT      = self . Translations   [ "UI::StartLoading"                    ]
    MSG      = FMT . format          ( self . windowTitle ( )                )
    self     . ShowStatus            ( MSG                                   )
    self     . OnBusy  . emit        (                                       )
    self     . setBustle             (                                       )
    ##########################################################################
    LOID     = self . LOID
    UUID     = 0
    LTYPE    = 0
    BODY     = None
    JSOX     =                       {                                       }
    LODTAB   = self . Tables         [ "LOD"                                 ]
    ##########################################################################
    QQ       = f"""select
                   `uuid` , `name` , `type` , `parameters` , `body`
                   from {LODTAB}
                   where ( `id` = {LOID} ) ;"""
    QQ       = " " . join            ( QQ . split ( )                        )
    ##########################################################################
    DB       . Query                 ( QQ                                    )
    RR       = DB . FetchOne         (                                       )
    ##########################################################################
    if ( ( RR not in [ False , None ] ) and ( len ( RR ) == 5 ) )            :
      ########################################################################
      UUID   = int                   ( RR [ 0                              ] )
      NAME   = self . assureString   ( RR [ 1                              ] )
      LTYPE  = int                   ( RR [ 2                              ] )
      JSOX   = self . toJSON         ( RR [ 3                              ] )
      BODY   =                         RR [ 4                                ]
      ########################################################################
      if ( ( BODY not in [ False , None ] ) and ( len ( BODY ) > 0 ) )       :
        ######################################################################
        OKAY           = True
        self . LodName = NAME
    ##########################################################################
    self     . setVacancy            (                                       )
    self     . GoRelax . emit        (                                       )
    self     . ShowStatus            ( ""                                    )
    DB       . Close                 (                                       )
    ##########################################################################
    if                               ( OKAY                                ) :
      ########################################################################
      self   . Uuid = UUID
      ########################################################################
      if                             ( 102 == LTYPE                        ) :
        ######################################################################
        self . LoadBareWaveFront     ( JSOX , BODY                           )
      ########################################################################
      elif                           ( 112 == LTYPE                        ) :
        ######################################################################
        self . LoadZipWaveFront      ( JSOX , BODY                           )
    ##########################################################################
    self . emitStartModel . emit     (                                       )
    ##########################################################################
    return
  ############################################################################
  def startup ( self                                                       ) :
    ##########################################################################
    self . Go ( self . loading                                               )
    ##########################################################################
    return
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  def ReportIt ( self                                                      ) :
    ##########################################################################
    ## FN     = f"D:/Workspaces/VTK/EyeBalls.vtk"
    ##########################################################################
    ## writer = vtk . vtkPolyDataWriter ( )
    ## writer . SetInputData            ( sphere.GetOutput() )
    ## writer . SetFileName             ( FN )
    ## writer . Update                  (    )
    ##########################################################################
    ## FN     = f"D:\\Workspaces\\VTK\\EyeBalls-{CNT}.json"
    ## FN     = f"D:/Workspaces/VTK"
    ## EXP = vtk . vtkJSONSceneExporter ( )
    ## EXP . SetFileName       ( FN              )
    ## EXP . SetInput          ( self . rWindow  )
    ## EXP . SetActiveRenderer ( self . renderer )
    ## EXP . Write             (                 )
    CNT     = 0
    actors  = self . renderer . GetActors (                                  )
    ##########################################################################
    for actor in actors                                                      :
      ########################################################################
      CNT   = CNT + 1
      ########################################################################
      ## print ( "Actor : " , CNT )
      ########################################################################
      vm     = actor . GetMapper (                                           )
      vi     = vm    . GetInput  (                                           )
      ########################################################################
      FN     = f"D:/Workspaces/VTK/EyeBalls-{CNT}.vtk"
      ##########################################################################
      writer = vtk . vtkPolyDataWriter (    )
      writer . SetInputData            ( vi )
      writer . SetFileName             ( FN )
      writer . Update                  (    )
      ########################################################################
      ## FN     = f"D:\\Workspaces\\VTK\\EyeBalls-{CNT}.json"
      ## writer = vtk . vtkJSONDataSetWriter (                                  )
      ## writer . SetFileName  ( FN                                             )
      ## writer . SetInputData ( vi                                             )
      ## writer . Write        (                                                )
      ## writer . Update       (                                                )
    ##########################################################################
    return
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ############################################################################
  ## 轉換到AITK JSON
  ############################################################################
  def ToAitkJSON         ( self , Details = True                           ) :
    ##########################################################################
    m        = ModelJson (                                                   )
    ##########################################################################
    ACTORx   =           {                                                   }
    actors   = self . renderer . GetActors (                                 )
    ##########################################################################
    CNT      = 0
    ##########################################################################
    if                   ( Details                                         ) :
      ########################################################################
      for actor in actors                                                    :
        ######################################################################
        NAME = f"{CNT}"
        ######################################################################
        AJON                = m . ActorToJSON ( actor                        )
        AJON   [ "Name"   ] = NAME
        ACTORx [ f"{CNT}" ] = AJON
        ######################################################################
        CNT  = CNT + 1
      ########################################################################
    else                                                                     :
      ########################################################################
      for actor in actors                                                    :
        ######################################################################
        ACTORx [ f"{CNT}" ] = { "Name" : f"{CNT}"                            }
        ######################################################################
        CNT  = CNT + 1
    ##########################################################################
    ##########################################################################
    ##########################################################################
    ##########################################################################
    ##########################################################################
    CAMERA   = m . CameraToJSON ( self . renderer . GetActiveCamera ( )      )
    ##########################################################################
    self . AitkJSON =  { "Name"        : self . LodName                    , \
                         "Camera"      : CAMERA                            , \
                         "TotalActors" : CNT                               , \
                         "Actors"      : ACTORx                              }
    ##########################################################################
    return
  ############################################################################
  ### 匯出JSON檔
  ############################################################################
  def ExportJSON               ( self                                      ) :
    ##########################################################################
    self  . ToAitkJSON         ( True                                        )
    ##########################################################################
    DPATH = self . Settings    [ "ModelPath"                                 ]
    LOD   = self . LodName
    ##########################################################################
    FN    = f"{DPATH}/{LOD}.json"
    ##########################################################################
    FRS   = self . getMenuItem ( "SaveJsonFilters"                           )
    MSG   = self . getMenuItem ( "ExportJSON"                                )
    ##########################################################################
    F , _ = QFileDialog . getSaveFileName ( self , MSG , FN , FRS            )
    ##########################################################################
    if                         ( len ( F ) <= 0                            ) :
      return
    ##########################################################################
    SaveJson                   ( F , self . AitkJSON                         )
    self . Notify              ( 5                                           )
    ##########################################################################
    return
  ############################################################################
  ### 匯入JSON檔
  ############################################################################
  def ImportJSON               ( self                                      ) :
    ##########################################################################
    self  . ToAitkJSON         (                                             )
    ##########################################################################
    DPATH = self . Settings    [ "ModelPath"                                 ]
    LOD   = self . LodName
    ##########################################################################
    FN    = f"{DPATH}/{LOD}.json"
    ##########################################################################
    FRS   = self . getMenuItem ( "SaveJsonFilters"                           )
    MSG   = self . getMenuItem ( "ImportJSON"                                )
    ##########################################################################
    F , _ = QFileDialog . getOpenFileName ( self , MSG , FN , FRS            )
    ##########################################################################
    if                         ( len ( F ) <= 0                            ) :
      return
    ##########################################################################
    self . AitkJSON = LoadJson ( F                                           )
    ##########################################################################
    self . Go                  ( self . PrepareForJSON                       )
    ##########################################################################
    return
  ############################################################################
  ### 匯出VTK目錄
  ############################################################################
  def ExportVTK                        ( self                              ) :
    ##########################################################################
    DPATH = self . Settings            [ "ModelPath"                         ]
    DIR   = QFileDialog . getExistingDirectory                               (
              self                                                           ,
              self . getMenuItem       ( "VtkDirectory"                    ) ,
              DPATH                                                          ,
              QFileDialog . ShowDirsOnly                                     )
    ##########################################################################
    if                                 ( DIR in [ False , None ]           ) :
      return
    ##########################################################################
    if                                 ( len ( DIR ) <= 0                  ) :
      return
    ##########################################################################
    LOD   = self . LodName
    DIR   = f"{DIR}/{LOD}"
    ##########################################################################
    EVTK  = vtk . vtkJSONSceneExporter (                                     )
    EVTK  . SetFileName                ( DIR                                 )
    EVTK  . SetInput                   ( self . rWindow                      )
    EVTK  . SetActiveRenderer          ( self . renderer                     )
    EVTK  . Write                      (                                     )
    ##########################################################################
    self  . Notify                     ( 5                                   )
    ##########################################################################
    return
  ############################################################################
  ### 匯入OBJ檔
  ############################################################################
  def ImportOBJ ( self                                                     ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ### 匯入OBJ/MTL檔
  ############################################################################
  def ImportOBJMTL ( self                                                  ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ### 匯出OBJ檔
  ############################################################################
  def ExportOBJ ( self                                                     ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ### 匯入STL檔
  ############################################################################
  def ImportSTL ( self                                                     ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ### 匯出STL檔
  ############################################################################
  def ExportSTL ( self                                                     ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ### 匯入glTL檔
  ############################################################################
  def ImportGLTF ( self                                                    ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ### 匯出glTL檔
  ############################################################################
  def ExportGLTF ( self                                                    ) :
    ##########################################################################
    ##########################################################################
    return
  ############################################################################
  ## 切換控制板
  ############################################################################
  def SwitchPad                      ( self                                ) :
    ##########################################################################
    if                               ( self . Pad                          ) :
      ########################################################################
      self . PadUi      . close      (                                       )
      ########################################################################
      self . Pad       = False
      self . PadUi     = None
      ########################################################################
    else                                                                     :
      ########################################################################
      VPAD  = VtkModelPad            ( None , self . PlanFunc                )
      TITLE = self     . getMenuItem ( "ControlPad"                          )
      ########################################################################
      VPAD  . Settings     = self . Settings
      VPAD  . Translations = self . Translations
      VPAD  . Hosts        = { "ERP"      : self . Settings [ "ERP"      ] , \
                               "Database" : self . Settings [ "Database" ] , \
                               "Oriphase" : self . Settings [ "Oriphase" ]   }
      VPAD  . DB           = self . Settings [ "Database"                    ]
      VPAD  . Tables       = self . Tables
      ########################################################################
      MENUZ = self . Translations              [ "VtkModelPad" ] [ "Menus"   ]
      ########################################################################
      VPAD  . setLocality            ( self . getLocality ( )                )
      VPAD  . setMenus               ( MENUZ                                 )
      ########################################################################
      VPAD  . rWindow  = self . rWindow
      VPAD  . renderer = self . renderer
      VPAD  . model    = self
      ########################################################################
      self  . addControl             ( TITLE , VPAD , self                   )
      ########################################################################
      VPAD  . startup                (                                       )
      ########################################################################
      self  . Pad      = True
      self  . PadUi    = VPAD
    ##########################################################################
    return
  ############################################################################
  ## 切換滑鼠追蹤控制
  ############################################################################
  def SwitchMouse ( self                                                   ) :
    ##########################################################################
    if            ( self . Mouse                                           ) :
      ########################################################################
      self . Mouse = False
      ########################################################################
    else                                                                     :
      ########################################################################
      self . Mouse = True
    ##########################################################################
    return
  ############################################################################
  def LodChanged ( self , LOD                                              ) :
    ##########################################################################
    self . LodName = LOD
    ##########################################################################
    return
  ############################################################################
  def ModelMenu                ( self , mm                                 ) :
    ##########################################################################
    MSG = self . getMenuItem   ( "ModelMenu"                                 )
    LOM = mm   . addMenu       ( MSG                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "BackgrounColor"                            )
    mm  . addActionFromMenu    ( LOM , 54233001 , msg                        )
    ##########################################################################
    msg = self . getMenuItem   ( "Report"                                    )
    mm  . addActionFromMenu    ( LOM , 54233002 , msg                        )
    ##########################################################################
    mm  . addSeparatorFromMenu ( LOM                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "ClearActors"                               )
    mm  . addActionFromMenu    ( LOM , 54233011 , msg                        )
    ##########################################################################
    return mm
  ############################################################################
  def RunModelMenu                 ( self , at                             ) :
    ##########################################################################
    if                             ( at == 54233001                        ) :
      ########################################################################
      self . ChangeBackgroundColor (                                         )
      ########################################################################
      return
    ##########################################################################
    if                             ( at == 54233002                        ) :
      ########################################################################
      self . ReportIt              (                                         )
      ########################################################################
      return
    ##########################################################################
    if                             ( at == 54233011                        ) :
      ########################################################################
      self . ClearActors           (                                         )
      ########################################################################
      return
    ##########################################################################
    return False
  ############################################################################
  def FilesMenu                ( self , mm                                 ) :
    ##########################################################################
    MSG = self . getMenuItem   ( "FilesMenu"                                 )
    LOM = mm   . addMenu       ( MSG                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "ImportJSON"                                )
    mm  . addActionFromMenu    ( LOM , 54233101 , msg                        )
    ##########################################################################
    msg = self . getMenuItem   ( "ExportJSON"                                )
    mm  . addActionFromMenu    ( LOM , 54233102 , msg                        )
    ##########################################################################
    mm  . addSeparatorFromMenu ( LOM                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "ExportVTK"                                 )
    mm  . addActionFromMenu    ( LOM , 54233201 , msg                        )
    ##########################################################################
    mm  . addSeparatorFromMenu ( LOM                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "ImportOBJ"                                 )
    mm  . addActionFromMenu    ( LOM , 54233301 , msg                        )
    ##########################################################################
    msg = self . getMenuItem   ( "ImportOBJMTL"                              )
    mm  . addActionFromMenu    ( LOM , 54233302 , msg                        )
    ##########################################################################
    msg = self . getMenuItem   ( "ExportOBJ"                                 )
    mm  . addActionFromMenu    ( LOM , 54233303 , msg                        )
    ##########################################################################
    mm  . addSeparatorFromMenu ( LOM                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "ImportSTL"                                 )
    mm  . addActionFromMenu    ( LOM , 54233401 , msg                        )
    ##########################################################################
    msg = self . getMenuItem   ( "ExportSTL"                                 )
    mm  . addActionFromMenu    ( LOM , 54233402 , msg                        )
    ##########################################################################
    mm  . addSeparatorFromMenu ( LOM                                         )
    ##########################################################################
    msg = self . getMenuItem   ( "ImportGLTF"                                )
    mm  . addActionFromMenu    ( LOM , 54233501 , msg                        )
    ##########################################################################
    msg = self . getMenuItem   ( "ExportGLTF"                                )
    mm  . addActionFromMenu    ( LOM , 54233502 , msg                        )
    ##########################################################################
    return mm
  ############################################################################
  def RunFilesMenu                ( self , at                              ) :
    ##########################################################################
    if                            ( at == 54233101                         ) :
      ########################################################################
      self . ImportJSON           (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233102                         ) :
      ########################################################################
      self . ExportJSON           (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233201                         ) :
      ########################################################################
      self . ExportVTK            (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233301                         ) :
      ########################################################################
      self . ImportOBJ            (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233302                         ) :
      ########################################################################
      self . ImportOBJMTL         (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233303                         ) :
      ########################################################################
      self . ExportOBJ            (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233401                         ) :
      ########################################################################
      self . ImportSTL            (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233402                         ) :
      ########################################################################
      self . ExportSTL            (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233501                         ) :
      ########################################################################
      self . ImportGLTF           (                                          )
      ########################################################################
      return
    ##########################################################################
    if                            ( at == 54233502                         ) :
      ########################################################################
      self . ExportGLTF           (                                          )
      ########################################################################
      return
    ##########################################################################
    return False
  ############################################################################
  def Menu                        ( self , pos                             ) :
    ##########################################################################
    doMenu = self . isFunction    ( self . HavingMenu                        )
    if                            ( not doMenu                             ) :
      return False
    ##########################################################################
    self   . Notify               ( 0                                        )
    ##########################################################################
    mm     = MenuManager          ( self                                     )
    ##########################################################################
    SERL   = LineEdit             ( None , self . PlanFunc                   )
    SERL   . setText              ( self . LodName                           )
    SERL   . textEdited . connect ( self . LodChanged                        )
    mm     . addWidget            ( 9999991 , SERL                           )
    ##########################################################################
    mm     . addSeparator         (                                          )
    ##########################################################################
    msg    = self . getMenuItem   ( "ControlPad"                             )
    mm     . addAction            ( 1101 , msg , True , self . Pad           )
    ##########################################################################
    msg    = self . getMenuItem   ( "TrackMouse"                             )
    mm     . addAction            ( 1102 , msg , True , self . Mouse         )
    ##########################################################################
    mm     . addSeparator         (                                          )
    ##########################################################################
    self   . ModelMenu            ( mm                                       )
    self   . FilesMenu            ( mm                                       )
    mm     . addSeparator         (                                          )
    self   . DockingMenu          ( mm                                       )
    ##########################################################################
    mm     . setFont              ( self    . menuFont ( )                   )
    aa     = mm . exec_           ( QCursor . pos      ( )                   )
    at     = mm . at              ( aa                                       )
    ##########################################################################
    if                            ( self . RunModelMenu ( at             ) ) :
      return True
    ##########################################################################
    if                            ( self . RunFilesMenu ( at             ) ) :
      return True
    ##########################################################################
    if                            ( self . RunDocking   ( mm , aa        ) ) :
      return True
    ##########################################################################
    if                            ( at == 1101                             ) :
      ########################################################################
      self . SwitchPad            (                                          )
      ########################################################################
      return True
    ##########################################################################
    if                            ( at == 1102                             ) :
      ########################################################################
      self . SwitchMouse          (                                          )
      ########################################################################
      return True
    ##########################################################################
    return True
##############################################################################
